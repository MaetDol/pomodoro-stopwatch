#!/usr/bin/env node
/* bundle-cpp.js
 * - í”„ë¡œì íŠ¸ ë‚´ë¶€ í—¤ë”("...")ë¥¼ ì¬ê·€ì ìœ¼ë¡œ ì¸ë¼ì¸í•´ì„œ ë‹¨ì¼ C++ íŒŒì¼ì„ ë§Œë“­ë‹ˆë‹¤.
 * - ì‹œìŠ¤í…œ/ì™¸ë¶€ í—¤ë”(<...>)ëŠ” ê¸°ë³¸ ê·¸ëŒ€ë¡œ ìœ ì§€(ì˜µì…˜ìœ¼ë¡œ ì¸ë¼ì¸ ê°€ëŠ¥).
 * - ì´ë¯¸ ì²˜ë¦¬í•œ íŒŒì¼ì€ ì¤‘ë³µ ì¸ë¼ì¸í•˜ì§€ ì•ŠìŒ(Include Guard íš¨ê³¼).
 *
 * ì‚¬ìš©:
 *   node bundle-cpp.js <entry.cpp|.ino> [includeDir ...] [-o <output>]
 * ì˜µì…˜:
 *   -o, --out <path>       ì¶œë ¥ íŒŒì¼ ê²½ë¡œ (ê¸°ë³¸: amalgamated.cpp)
 *   --inline-system        <...> í—¤ë”ë„ ì¸ë¼ì¸ ì‹œë„
 *   --no-strip-pragma-once #pragma once ë¼ì¸ ìœ ì§€(ê¸°ë³¸: ì œê±°)
 *   --print-deps           ì²˜ë¦¬ ìˆœì„œ(ì˜ì¡´ì„±) ì¶œë ¥
 */

"use strict";
const fs = require("fs");
const path = require("path");

const INCLUDE_RE = /^\s*#\s*include\s*([<"])\s*([^">]+?)\s*[>"]\s*.*$/;
const PRAGMA_ONCE_RE = /^\s*#\s*pragma\s+once\b/;

function parseArgs(argv) {
  let out = "amalgamated.cpp";
  let inlineSystem = false;
  let stripPragmaOnce = true;
  let printDeps = false;

  const positional = [];
  for (let i = 0; i < argv.length; i++) {
    const a = argv[i];
    if (a === "-h" || a === "--help") return { help: true };
    else if (a === "-o" || a === "--out") out = argv[++i];
    else if (a === "--inline-system") inlineSystem = true;
    else if (a === "--no-strip-pragma-once") stripPragmaOnce = false;
    else if (a === "--print-deps") printDeps = true;
    else positional.push(a);
  }
  if (positional.length < 1) {
    return { error: "ì—”íŠ¸ë¦¬ íŒŒì¼ì„ ì§€ì •í•´ì£¼ì„¸ìš” (ì˜ˆ: src/main.cpp)" };
  }
  const entry = positional[0];
  const includeDirs = positional.slice(1);
  return { out, inlineSystem, stripPragmaOnce, printDeps, entry, includeDirs };
}

function fileExists(p) {
  try {
    return fs.existsSync(p) && fs.statSync(p).isFile();
  } catch {
    return false;
  }
}

function resolveInclude(kind, inc, basedir, includeDirs, inlineSystem) {
  // <...>ëŠ” ê¸°ë³¸ ìœ ì§€. --inline-system ì‹œì—ëŠ” ê²½ë¡œ íƒìƒ‰
  if (kind === "<" && !inlineSystem) return null;

  // 1) í˜„ì¬ íŒŒì¼ ê¸°ì¤€ ìƒëŒ€ ê²½ë¡œ
  let cand = path.resolve(basedir, inc);
  if (fileExists(cand)) return cand;

  // 2) ì§€ì •í•œ include ë””ë ‰í„°ë¦¬ ëª©ë¡
  for (const d of includeDirs) {
    cand = path.resolve(d, inc);
    if (fileExists(cand)) return cand;
  }
  return null; // ëª» ì°¾ìœ¼ë©´ ì›ë¬¸ ë¼ì¸ ê·¸ëŒ€ë¡œ ë‘ 
}

function readText(p) {
  return fs.readFileSync(p, "utf8");
}

function bundle(entry, includeDirs, opts) {
  const seen = new Set(); // ì¤‘ë³µ ì¸ë¼ì¸ ë°©ì§€
  const out = [];
  const deps = [];

  function processFile(filePath) {
    const abs = path.resolve(filePath);
    if (seen.has(abs)) return;
    seen.add(abs);
    deps.push(abs);

    const basedir = path.dirname(abs);
    const text = readText(abs);
    const lines = text.split(/\r?\n/);

    for (let line of lines) {
      // #pragma once ì œê±°(ì˜µì…˜)
      if (opts.stripPragmaOnce && PRAGMA_ONCE_RE.test(line)) continue;

      const m = line.match(INCLUDE_RE);
      if (m) {
        const kind = m[1]; // '<' ë˜ëŠ” '"'
        const inc = m[2];
        const target = resolveInclude(
          kind,
          inc,
          basedir,
          includeDirs,
          opts.inlineSystem
        );

        if (target) {
          out.push(
            `\n/* ==== begin include "${inc}" from ${path.basename(abs)} ==== */`
          );
          processFile(target);
          out.push(`/* ==== end include "${inc}" ==== */\n`);
          continue;
        }
        // ëª» ì°¾ì€ ê²½ìš°(ë˜ëŠ” <...> ìœ ì§€): ì›ë¬¸ ë¼ì¸ ê·¸ëŒ€ë¡œ
      }
      out.push(line);
    }
  }

  // includeDirsì— ì—”íŠ¸ë¦¬ íŒŒì¼ì˜ ë””ë ‰í„°ë¦¬ë¥¼ ê¸°ë³¸ í¬í•¨
  const extra = path.dirname(path.resolve(entry));
  const searchDirs = Array.from(
    new Set([extra, ...includeDirs.map((d) => path.resolve(d))])
  );

  out.push("// generated by bundle-cpp.js");
  out.push("// search include dirs:");
  for (const d of searchDirs) out.push(`//   - ${d}`);
  out.push("");

  processFile(entry);

  return { code: out.join("\n"), deps };
}

function main() {
  const arg = parseArgs(process.argv.slice(2));
  if (arg.help) {
    console.log(readText(__filename).split("\n").slice(0, 40).join("\n"));
    process.exit(0);
  }
  if (arg.error) {
    console.error("ì—ëŸ¬:", arg.error);
    console.error("ë„ì›€ë§: node bundle-cpp.js -h");
    process.exit(1);
  }

  const { out, inlineSystem, stripPragmaOnce, printDeps, entry, includeDirs } =
    arg;

  const { code, deps } = bundle(entry, includeDirs, {
    inlineSystem,
    stripPragmaOnce,
  });

  fs.writeFileSync(out, code, "utf8");
  console.log(`âœ… wrote ${out}`);
  if (printDeps) {
    console.log("ğŸ“¦ processed files (order):");
    for (const d of deps) console.log(" -", d);
  }
}

if (require.main === module) main();
